;────────────────────────────────────
;죠교終了の処理
;────────────────────────────────────
@EVENTEND

;ムラムラリセット
SIF TARGET > 0
	CFLAG:무라무라 = 0
SIF ASSI:1 > 0
	CFLAG:(ASSI:1):무라무라 = 0
SIF ASSI:2 > 0
	CFLAG:(ASSI:2):무라무라 = 0

;MASTER側のCFLAGに誰にどれだけ搾られたかを기록
;一回で最大5000くらい？
CFLAG:MASTER:(2200 + NO:TARGET) += TFLAG:취득마력 * (5 + CFLAG:랭크) / 5
;ASSIはTARGETの1/5
FOR LOCAL, 0, 9
	IF ASSI:(LOCAL + 1) > 0
		CFLAG:MASTER:(2200 + NO:(ASSI:(LOCAL + 1))) += TFLAG:취득마력 * (5 + CFLAG:(ASSI:(LOCAL + 1)):랭크) / 25
	ENDIF
NEXT

;누적마력
SIF TARGET > 0
	CFLAG:누적마력 += TFLAG:취득마력

;죠교終了
FLAG:조교중 = 0
;OriginalString : 죠교は終わりま했다。
PRINTW 조교는 끝났습니다.

EXP:MASTER:성지식 += TFLAG:경과시간 / 10
EXP:성지식 += TFLAG:경과시간 / 10

;죠교시간をチェックして기록(최장・최단)
SIF TFLAG:경과시간 > FLAG:최장죠교시간기록
	FLAG:최장죠교시간기록 = TFLAG:경과시간
SIF TFLAG:경과시간 > 0 && (TFLAG:경과시간 < FLAG:최단죠교시간기록 || FLAG:최단죠교시간기록 == 0)
	FLAG:최단죠교시간기록 = TFLAG:경과시간

;ACT長期보정値の一括算入
CALL ACT_M_RESEARCH_L(1)

;データベース記入
CALL DATABASE_INPUT_T

;────────────────────────────────────
;모유の価値の計算
;────────────────────────────────────
SIF TALENT:MASTER:모유체질 && TFLAG:죠교시간 > 0
	CALL SELL_MILK

;────────────────────────────────────
;レベルアップ。たくさん경험치ためても一回の죠교は一度だけレベルアップできる仕様です
;────────────────────────────────────
IF TFLAG:일회휴게 == 0
	IF CFLAG:MASTER:죠교경험 > CFLAG:MASTER:필요경험치
		CFLAG:MASTER:죠교레벨 += 1
		CFLAG:MASTER:죠교경험 -= CFLAG:MASTER:필요경험치
		CFLAG:MASTER:필요경험치 += 100 + CFLAG:MASTER:죠교레벨 * CFLAG:MASTER:죠교레벨 * 10
		;レベル１０以降필요경험치は急に上がりますが、이상경험で軽減できます
		LOCAL = 250 + (CFLAG:MASTER:죠교레벨 - 5) * CFLAG:MASTER:필요경험치 / 3 - EXP:MASTER:이상경험 * 20
		SIF LOCAL > 0 && CFLAG:MASTER:죠교레벨 > 10
			CFLAG:MASTER:필요경험치 += LOCAL
		PRINTFORMW %CALLNAME:MASTER%의 조교 레벨은[{CFLAG:MASTER:죠교레벨}](이)가 되었습니다
		MAXBASE:MASTER:체력 += 100 + 10 * RAND:6
		MAXBASE:MASTER:기력 += 50 + 10 * RAND:6
	ENDIF
	
	IF CFLAG:죠교경험 > CFLAG:필요경험치
		CFLAG:죠교레벨 += 1
		CFLAG:죠교경험 -= CFLAG:필요경험치
		CFLAG:필요경험치 += 100 + CFLAG:죠교레벨 * CFLAG:죠교레벨 * 10
		LOCAL = 250 + (CFLAG:죠교레벨 - 5) * CFLAG:필요경험치 / 3 - EXP:MASTER:이상경험 * 20
		SIF LOCAL > 0 && CFLAG:죠교레벨 > 10
			CFLAG:필요경험치 += LOCAL
		PRINTFORMW %CALLNAME:TARGET%의 조교 레벨은[{CFLAG:죠교레벨}](이)가 되었습니다
		MAXBASE:체력 += 100 + 10 * RAND:6
		MAXBASE:기력 += 50 + 10 * RAND:6
	ENDIF
	
	TFLAG:취득마력 = MAX(TFLAG:취득마력, 10)
	PRINTFORMW %CALLNAME:TARGET%(은)는 %CALLNAME:MASTER%(으)로부터 빨아 들인 정력을{TFLAG:취득마력}의 마력으로 변환했다
	CFLAG:마력 += TFLAG:취득마력
	
	[SKIPSTART]
	IF CFLAG:호의 >= 500 && CFLAG:M연모 == 0
		CFLAG:M연모 = 1
		PRINTFORML %CALLNAME:TARGET%의 %CALLNAME:MASTER%(을)를 보는 눈이 이상하다…
		PRINTFORMW %CALLNAME:TARGET%은(는) %CALLNAME:MASTER%에 호의를 대기 시작한 것 같다
		IF CFLAG:호의 / 250 >= CFLAG:죠교레벨 - CFLAG:MASTER:죠교레벨
			CFLAG:M연모 = 2
			PRINTFORMW 그 뿐만 아니라,%CALLNAME:TARGET%에 %CALLNAME:MASTER%에의 친애의 정이 싹튼 것 같다
		ENDIF
	ENDIF
	IF CFLAG:호의 / 250 >= CFLAG:죠교레벨 - CFLAG:MASTER:죠교레벨 && CFLAG:M연모 == 1
		CFLAG:M연모 = 2
		PRINTFORML %CALLNAME:TARGET%의 %CALLNAME:MASTER%(을)를 보는 눈이 이상하다…
		PRINTFORMW %CALLNAME:TARGET%에 %CALLNAME:MASTER%에의 친애의 정이 싹튼 것 같다
	ENDIF
	[SKIPEND]
ENDIF

;────────────────────────────────────
;平時아라이멘도の変動
;────────────────────────────────────
LOCAL = 10 * CFLAG:아라이멘도 - CFLAG:평상시
LOCAL:1 = (CFLAG:SM성격 + CFLAG:츤데레 + 200) / 2
;성격で倍率が決まる。
;最小値50(Mデレ)、最大値150(Sツン)、素質変動しない/させないキャラではB = 100
CFLAG:평상시 += LOCAL * (LOCAL >= 0 ? 200 - LOCAL:1 # LOCAL:1) / 500
IF CFLAG:평상시 > 100 && MARK:5 == 0
	MARK:5 = 1
	CFLAG:반발제거 = 1
ELSEIF CFLAG:평상시 > 200 && MARK:5 == 1
	MARK:5 = 2
	CFLAG:반발제거 = 1
ELSEIF CFLAG:평상시 > 300 && MARK:5 == 2
	MARK:5 = 3
	CFLAG:반발제거 = 1
ELSEIF CFLAG:평상시 > 400 && MARK:5 == 3
	MARK:5 = 4
	CFLAG:반발제거 = 1
ELSEIF CFLAG:평상시 > 500 && MARK:5 == 4
	MARK:5 = 5
	CFLAG:반발제거 = 1
ELSEIF CFLAG:평상시 > 600 && MARK:5 == 5
	MARK:5 = 6
	CFLAG:반발제거 = 1
ELSEIF CFLAG:평상시 > 700 && MARK:5 == 6
	MARK:5 = 7
	CFLAG:반발제거 = 1
ELSEIF CFLAG:평상시 > 800 && MARK:5 == 7
	MARK:5 = 8
	CFLAG:반발제거 = 1
ELSEIF CFLAG:평상시 > 900 && MARK:5 == 8
	MARK:5 = 9
	CFLAG:반발제거 = 1
ELSEIF CFLAG:평상시 > 950 && MARK:5 == 9
	MARK:5 = 10
	CFLAG:반발제거 = 1
ENDIF
;────────────────────────────────────
;드라이사정ボーナス
;────────────────────────────────────
IF TCVAR:MASTER:드라이사정수 > 0 
	IF MAXBASE:MASTER:사정 < 7500 + CFLAG:MASTER:정력한계 * 500
		MAXBASE:MASTER:사정 = MIN(MAXBASE:MASTER:사정 + TCVAR:MASTER:드라이사정수 * 100, 7500 + CFLAG:MASTER:정력한계 * 500)
		PRINTFORML 한계를 넘어 짜졌기 때문에,%CALLNAME:MASTER%의 성적 기능이 강화되었습니다
	ELSE
		PRINTFORML 성적 기능의 강화가 한계에 이르고 있습니다
	ENDIF
	TCVAR:MASTER:드라이사정수 = 0
ENDIF

;────────────────────────────────────
;リセット
;────────────────────────────────────
;소변ゲージを消す
MAXBASE:MASTER:소변 = TALENT:MASTER:오줌싸개 ? MAXBASE:MASTER:소변 # 0
;죠교で蓄積했다피폐を일상に加算
CFLAG:MASTER:소모 = MIN(CFLAG:MASTER:소모 + MAX(TFLAG:63, 0), 20)
SIF TARGET >= 0
	CFLAG:TARGET:소모 += MAX(TFLAG:62, 0)

BEGIN TURNEND
